import{u as e,F as a}from"./useForm-0cf5fadd.js";import{e as l,K as s,J as o,L as t,r,w as i,o as d,l as n,m as c,y as p,x as u,k as m,D as v,z as h,G as f,a5 as w,a9 as g,a6 as y,O as b,P as k}from"./index-dc787e95.js";import{E as _}from"./el-button-adf54e9f.js";import{E as x,a as R}from"./el-divider-7e837124.js";import{u as F}from"./useValidator-ce35917e.js";const P=p("h2",{class:"text-2xl font-bold text-center w-[100%]"},"短信验证码登录",-1),j={class:"w-[100%] flex"},C={class:"w-[100%]"},I={class:"w-[100%] mt-15px"},V=l({__name:"TelephoneCodeForm",emits:["to-login"],setup(l,{emit:V}){const{register:q,elFormRef:D,methods:E}=e(),{t:z}=f(),{required:A}=F(),{currentRoute:U,addRoute:G,push:J}=s(),K=o(),L=t([{field:"title",colProps:{span:24}},{field:"telephone",label:z("login.telephone"),value:"",component:"Input",colProps:{span:24},componentProps:{style:{width:"100%"},placeholder:z("login.telephonePlaceholder"),maxlength:11}},{field:"password",label:"短信验证码",colProps:{span:24}},{field:"method",label:"登录类型",value:"1",component:"Input",ifshow:()=>!1},{field:"login",colProps:{span:24}}]),O={telephone:[A()],method:[A()],password:[A()]},S=()=>{V("to-login")},T=r(!1),X=r("");i((()=>U.value),(e=>{var a;X.value=null==(a=null==e?void 0:e.query)?void 0:a.redirect}),{immediate:!0});const B=async()=>{const e=m(D);await(null==e?void 0:e.validate((async e=>{if(e){T.value=!0;const{getFormData:e}=E,l=await e(),s=w();try{const e=await s.login(l);e?e.data.is_reset_password?Q():J({path:"/reset/password"}):T.value=!1}catch(a){T.value=!1}}})))};let H=r(!0),M=r(60);const N=async()=>{const e=m(D);await(null==e?void 0:e.validateField("telephone",(async e=>{if(e){H.value=!1,M.value=60;const{getFormData:e}=E,l=await e();try{const e=await g({telephone:l.telephone});if(null==e?void 0:e.data){let e=setInterval((()=>{M.value--,M.value<1&&(H.value=!0,clearInterval(e))}),1e3)}else y.error("发送失败，请联系管理员"),H.value=!0}catch(a){H.value=!0}}})))},Q=async()=>{const e=await b();if(e){const{wsCache:a}=k(),l=e.data||[];a.set("roleRouters",l),await K.generateRoutes(l).catch((()=>{})),K.getAddRouters.forEach((e=>{G(e)})),K.setIsAddRouters(!0),J({path:X.value||K.addRouters[0].path})}};return(e,l)=>(d(),n(m(a),{schema:L,rules:O,"label-position":"top","hide-required-asterisk":"",size:"large",class:"dark:border-1 dark:border-[var(--el-border-color)] dark:border-solid",onRegister:m(q)},{title:c((()=>[P])),password:c((e=>[p("div",j,[u(m(R),{modelValue:e.password,"onUpdate:modelValue":a=>e.password=a,placeholder:"请输入短信验证码"},{suffix:c((()=>[u(m(x),{direction:"vertical"}),m(H)?(d(),n(m(_),{key:0,type:"primary",link:"",onClick:N},{default:c((()=>[v(" 获取验证码 ")])),_:1})):(d(),n(m(_),{key:1,type:"primary",disabled:!m(H),link:""},{default:c((()=>[v(h(m(M))+"S后再试 ",1)])),_:1},8,["disabled"]))])),_:2},1032,["modelValue","onUpdate:modelValue"])])])),login:c((()=>[p("div",C,[u(m(_),{type:"primary",class:"w-[100%]",loading:T.value,onClick:B},{default:c((()=>[v(h(m(z)("login.login")),1)])),_:1},8,["loading"])]),p("div",I,[u(m(_),{class:"w-[100%]",onClick:S},{default:c((()=>[v(" 密码登录 ")])),_:1})])])),_:1},8,["schema","onRegister"]))}});export{V as _};
